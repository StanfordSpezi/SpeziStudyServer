#
# This source file is part of the SpeziStudyServer open source project
#
# SPDX-FileCopyrightText: 2026 Stanford University and the project authors (see CONTRIBUTORS.md)
#
# SPDX-License-Identifier: MIT
#

volumes:
  db_data:
  keycloak_db_data:

services:
  db:
    image: postgres:18-alpine
    volumes:
      - db_data:/var/lib/postgresql/data
    environment:
      POSTGRES_USER: &db_username ${DATABASE_USERNAME}
      POSTGRES_PASSWORD: &db_password ${DATABASE_PASSWORD}
      POSTGRES_DB: &db_name ${DATABASE_NAME}
    ports:
      - '5432:5432'
    healthcheck:
      test: ["CMD-SHELL", "pg_isready"]
      interval: 5s
      timeout: 5s
      retries: 5
  app:
    image: spezistudyserver:latest
    build:
      context: .
    environment:
      LOG_LEVEL: ${LOG_LEVEL}
      DATABASE_HOST: db
      DATABASE_NAME: *db_name
      DATABASE_USERNAME: *db_username
      DATABASE_PASSWORD: *db_password
      KEYCLOAK_URL: http://keycloak:8080
      KEYCLOAK_REALM: ${KEYCLOAK_REALM}
      KEYCLOAK_CLIENT_ID: ${KEYCLOAK_CLIENT_ID}
      KEYCLOAK_CLIENT_SECRET: ${KEYCLOAK_CLIENT_SECRET}
      KEYCLOAK_REQUIRED_ROLE: ${KEYCLOAK_REQUIRED_ROLE}
    depends_on:
      db:
        condition: service_healthy
      keycloak:
        condition: service_healthy
    ports:
      - '8080:8080'
    command: ["serve", "--env", "production", "--hostname", "0.0.0.0", "--port", "8080"]
  migrate:
    image: spezistudyserver:latest
    build:
      context: .
    environment:
      DATABASE_HOST: db
      DATABASE_NAME: *db_name
      DATABASE_USERNAME: *db_username
      DATABASE_PASSWORD: *db_password
    depends_on:
      db:
        condition: service_healthy
    command: ["migrate", "--yes"]
    deploy:
      replicas: 0
  revert:
    image: spezistudyserver:latest
    build:
      context: .
    environment:
      DATABASE_HOST: db
      DATABASE_NAME: *db_name
      DATABASE_USERNAME: *db_username
      DATABASE_PASSWORD: *db_password
    depends_on:
      db:
        condition: service_healthy
    command: ["migrate", "--revert", "--yes"]
    deploy:
      replicas: 0
  keycloak-db:
    image: postgres:18-alpine
    volumes:
      - keycloak_db_data:/var/lib/postgresql/data
    environment:
      POSTGRES_USER: &kc_db_username ${KEYCLOAK_DB_USERNAME}
      POSTGRES_PASSWORD: &kc_db_password ${KEYCLOAK_DB_PASSWORD}
      POSTGRES_DB: &kc_db_name ${KEYCLOAK_DB_NAME}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready"]
      interval: 5s
      timeout: 5s
      retries: 5
  keycloak:
    image: quay.io/keycloak/keycloak:26.0
    command: start-dev --import-realm --health-enabled=true
    environment:
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD}
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://keycloak-db:5432/${KEYCLOAK_DB_NAME}
      KC_DB_USERNAME: *kc_db_username
      KC_DB_PASSWORD: *kc_db_password
    volumes:
      - ./docker/keycloak/realm-export.json:/opt/keycloak/data/import/realm-export.json:ro
    depends_on:
      keycloak-db:
        condition: service_healthy
    ports:
      - '8180:8080'
    healthcheck:
      test: ["CMD", "bash", "-c", "cat < /dev/null > /dev/tcp/localhost/9000"]
      start_period: 30s
      interval: 10s
      timeout: 5s
      retries: 12
