#
# This source file is part of the SpeziStudyServer open source project
#
# SPDX-FileCopyrightText: 2026 Stanford University and the project authors (see CONTRIBUTORS.md)
#
# SPDX-License-Identifier: MIT
#

openapi: 3.0.3
info:
  title: Study Definition API
  version: 1.0.0

security:
  - bearerAuth: []

paths:
  /groups:
    get:
      tags:
        - Groups
      summary: List all groups (synced from Keycloak)
      responses:
        '200':
          description: List of groups
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/GroupResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /groups/{groupId}:
    get:
      tags:
        - Groups
      summary: Get a group by ID
      parameters:
        - $ref: '#/components/parameters/GroupId'
      responses:
        '200':
          description: The group
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GroupResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /groups/{groupId}/studies:
    get:
      tags:
        - Studies
      summary: List all studies in a group
      parameters:
        - $ref: '#/components/parameters/GroupId'
      responses:
        '200':
          description: List of studies with ID and title
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/StudyListItem'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

    post:
      tags:
        - Studies
      summary: Create a study in a group
      parameters:
        - $ref: '#/components/parameters/GroupId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StudyCreateInput'
      responses:
        '201':
          description: Study created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StudyResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /studies/{studyId}:
    get:
      tags:
        - Studies
      summary: Get a study by ID
      parameters:
        - name: studyId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Study found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StudyResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

    patch:
      tags:
        - Studies
      summary: Partially update a study
      parameters:
        - name: studyId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StudyPatchInput'
      responses:
        '200':
          description: Study updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StudyResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      tags:
        - Studies
      summary: Delete a study by ID
      parameters:
        - name: studyId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Study deleted
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /studies/{studyId}/bundle:
    get:
      tags:
        - Download
      summary: Download the full study bundle as a ZIP file
      parameters:
        - name: studyId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Study bundle ZIP file
          headers:
            Content-Disposition:
              schema:
                type: string
              description: Attachment header for file download
          content:
            application/zip:
              schema:
                type: string
                format: binary
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /studies/{studyId}/components:
    get:
      tags:
        - Components
      summary: List all components for a study
      parameters:
        - name: studyId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: List of components
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Component'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /studies/{studyId}/components/{componentId}:
    delete:
      tags:
        - Components
      summary: Remove a component
      parameters:
        - name: studyId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: componentId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Component deleted
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /studies/{studyId}/components/informational:
    post:
      tags:
        - Informational Components
      summary: Add an informational component to a study
      parameters:
        - name: studyId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/InformationalComponentInput'
      responses:
        '201':
          description: Component added
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InformationalComponentResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /studies/{studyId}/components/informational/{componentId}:
    get:
      tags:
        - Informational Components
      summary: Get a single informational component
      parameters:
        - name: studyId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: componentId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: The informational component
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InformationalComponentResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

    put:
      tags:
        - Informational Components
      summary: Replace an informational component
      parameters:
        - name: studyId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: componentId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/InformationalComponentInput'
      responses:
        '200':
          description: Component replaced
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InformationalComponentResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /studies/{studyId}/components/questionnaire:
    post:
      tags:
        - Questionnaire Components
      summary: Add a questionnaire component to a study
      parameters:
        - name: studyId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/QuestionnaireComponentInput'
      responses:
        '201':
          description: Component added
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QuestionnaireComponentResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /studies/{studyId}/components/questionnaire/{componentId}:
    get:
      tags:
        - Questionnaire Components
      summary: Get a single questionnaire component
      parameters:
        - name: studyId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: componentId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: The questionnaire component
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QuestionnaireComponentResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

    put:
      tags:
        - Questionnaire Components
      summary: Replace a questionnaire component
      parameters:
        - name: studyId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: componentId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/QuestionnaireComponentInput'
      responses:
        '200':
          description: Component replaced
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QuestionnaireComponentResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /studies/{studyId}/components/health-data:
    post:
      tags:
        - Health Data Components
      summary: Add a health data component to a study
      parameters:
        - name: studyId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/HealthDataComponentInput'
      responses:
        '201':
          description: Component added
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthDataComponentResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /studies/{studyId}/components/health-data/{componentId}:
    get:
      tags:
        - Health Data Components
      summary: Get a single health data component
      parameters:
        - name: studyId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: componentId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: The health data component
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthDataComponentResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

    put:
      tags:
        - Health Data Components
      summary: Replace a health data component
      parameters:
        - name: studyId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: componentId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/HealthDataComponentInput'
      responses:
        '200':
          description: Component replaced
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthDataComponentResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /studies/{studyId}/components/{componentId}/schedules:
    get:
      tags:
        - Schedules
      summary: List all schedules for a component
      parameters:
        - name: studyId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: componentId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: List of schedules
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ComponentSchedule'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

    post:
      tags:
        - Schedules
      summary: Add a schedule to a component
      parameters:
        - name: studyId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: componentId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ComponentSchedule'
      responses:
        '201':
          description: Schedule added
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ComponentSchedule'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'

  /studies/{studyId}/components/{componentId}/schedules/{scheduleId}:
    get:
      tags:
        - Schedules
      summary: Get a single schedule
      parameters:
        - name: studyId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: componentId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: scheduleId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: The schedule
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ComponentSchedule'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

    put:
      tags:
        - Schedules
      summary: Replace a schedule
      parameters:
        - name: studyId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: componentId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: scheduleId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ComponentSchedule'
      responses:
        '200':
          description: Schedule replaced
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ComponentSchedule'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'

    delete:
      tags:
        - Schedules
      summary: Remove a schedule
      parameters:
        - name: studyId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: componentId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: scheduleId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Schedule deleted
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

components:
  parameters:
    GroupId:
      name: groupId
      in: path
      required: true
      schema:
        type: string
        format: uuid

  responses:
    BadRequest:
      description: Bad request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'
    NotFound:
      description: Not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'
    Unauthorized:
      description: Authentication required
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'
    Forbidden:
      description: Insufficient permissions
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'
    Conflict:
      description: Conflict
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'
    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Keycloak-issued JWT access token
  schemas:

    # ── Shared ────────────────────────────────────────────────────────────

    ProblemDetails:
      type: object
      description: RFC 7807 Problem Details for HTTP APIs
      required:
        - title
        - status
      properties:
        title:
          type: string
          description: A short, human-readable summary of the problem type
        status:
          type: integer
          description: The HTTP status code
        detail:
          type: string
          description: A human-readable explanation specific to this occurrence

    LocalizedString:
      type: object
      description: Localized string keyed by locale (e.g., "en-US" -> "value")
      additionalProperties:
        type: string
      example:
        en-US: "Hello"

    DateComponents:
      type: object
      description: >
        Calendar-relative offset applied from the session creation time.
        At least one component must be provided. Uses Swift DateComponents naming (singular).
      properties:
        year:
          type: integer
          minimum: 0
        month:
          type: integer
          minimum: 0
        day:
          type: integer
          minimum: 0
      additionalProperties: false

    SampleTypesCollection:
      type: array
      description: HealthKit sample types in SpeziHealthKit format (ClassName;Identifier)
      items:
        type: string
      example:
        - "HKQuantityType;HKQuantityTypeIdentifierHeartRate"
        - "HKQuantityType;HKQuantityTypeIdentifierStepCount"
        - "HKCategoryType;HKCategoryTypeIdentifierSleepAnalysis"

    # ── Groups ────────────────────────────────────────────────────────────

    GroupResponse:
      type: object
      description: Group synced from Keycloak. Name is unique.
      required:
        - id
        - name
        - icon
      properties:
        id:
          type: string
          format: uuid
          description: Keycloak group ID
        name:
          type: string
          description: Unique group name (matches Keycloak group name)
        icon:
          type: string
          description: Icon identifier (e.g. SF Symbol name, stored as Keycloak group attribute)

    # ── Studies — Building Blocks ─────────────────────────────────────────

    StudyDetailContent:
      type: object
      description: Per-locale study detail fields
      properties:
        shortTitle:
          type: string
        explanationText:
          type: string
        shortExplanationText:
          type: string

    StudyDetailData:
      type: object
      description: Localized study details keyed by locale
      additionalProperties:
        $ref: '#/components/schemas/StudyDetailContent'
      example:
        en-US:
          shortTitle: "MHC"
          explanationText: "This study aims to..."
          shortExplanationText: "A heart health study"

    ParticipationCriterion:
      description: >
        A criterion which must be satisfied for a person to participate in a study.
        Uses a discriminated union on "type". Leaf criteria carry a single value.
        Logical operators (not, all, any) are recursive.
      oneOf:
        - $ref: '#/components/schemas/AgeAtLeastCriterion'
        - $ref: '#/components/schemas/IsFromRegionCriterion'
        - $ref: '#/components/schemas/SpeaksLanguageCriterion'
        - $ref: '#/components/schemas/NotCriterion'
        - $ref: '#/components/schemas/AllCriterion'
        - $ref: '#/components/schemas/AnyCriterion'
      discriminator:
        propertyName: type
        mapping:
          ageAtLeast: '#/components/schemas/AgeAtLeastCriterion'
          isFromRegion: '#/components/schemas/IsFromRegionCriterion'
          speaksLanguage: '#/components/schemas/SpeaksLanguageCriterion'
          not: '#/components/schemas/NotCriterion'
          all: '#/components/schemas/AllCriterion'
          any: '#/components/schemas/AnyCriterion'

    AgeAtLeastCriterion:
      type: object
      description: Requires the participant to be at least a certain age
      required:
        - type
        - age
      properties:
        type:
          type: string
          enum: [ageAtLeast]
        age:
          type: integer
          minimum: 0
      additionalProperties: false

    IsFromRegionCriterion:
      type: object
      description: Requires the participant to be from a specific region
      required:
        - type
        - region
      properties:
        type:
          type: string
          enum: [isFromRegion]
        region:
          type: string
          description: Region identifier (e.g. "US", "DE")
      additionalProperties: false

    SpeaksLanguageCriterion:
      type: object
      description: Requires the participant to speak a specific language
      required:
        - type
        - language
      properties:
        type:
          type: string
          enum: [speaksLanguage]
        language:
          type: string
          description: Language identifier (e.g. "en", "de")
      additionalProperties: false

    NotCriterion:
      type: object
      description: Negates a criterion
      required:
        - type
        - criterion
      properties:
        type:
          type: string
          enum: [not]
        criterion:
          $ref: '#/components/schemas/ParticipationCriterion'
      additionalProperties: false

    AllCriterion:
      type: object
      description: Requires all criteria to be satisfied (logical AND)
      required:
        - type
        - criteria
      properties:
        type:
          type: string
          enum: [all]
        criteria:
          type: array
          items:
            $ref: '#/components/schemas/ParticipationCriterion'
      additionalProperties: false
      example:
        type: all
        criteria:
          - type: ageAtLeast
            age: 18
          - type: any
            criteria:
              - type: isFromRegion
                region: "US"
              - type: isFromRegion
                region: "DE"

    AnyCriterion:
      type: object
      description: Requires at least one criterion to be satisfied (logical OR)
      required:
        - type
        - criteria
      properties:
        type:
          type: string
          enum: [any]
        criteria:
          type: array
          items:
            $ref: '#/components/schemas/ParticipationCriterion'
      additionalProperties: false

    # ── Studies — Request / Response ──────────────────────────────────────

    StudyListItem:
      type: object
      description: Summary of a study for list views
      required:
        - id
        - title
      properties:
        id:
          type: string
          format: uuid
        title:
          $ref: '#/components/schemas/LocalizedString'

    StudyCreateInput:
      type: object
      description: Request body for creating a new study
      required:
        - title
        - locales
        - icon
      properties:
        title:
          $ref: '#/components/schemas/LocalizedString'
        locales:
          type: array
          description: Supported locales for the study
          items:
            type: string
          minItems: 1
          example: ["en-US"]
        icon:
          type: string
          description: Icon identifier (e.g. SF Symbol name)
          example: heart
        participationCriterion:
          $ref: '#/components/schemas/ParticipationCriterion'

    StudyPatchInput:
      type: object
      description: Partial update for a study. All fields are optional.
      properties:
        title:
          $ref: '#/components/schemas/LocalizedString'
        locales:
          type: array
          description: Supported locales for the study
          items:
            type: string
          minItems: 1
          example: ["en-US", "de-DE"]
        icon:
          type: string
          description: Icon identifier (e.g. SF Symbol name)
          example: heart
        details:
          $ref: '#/components/schemas/StudyDetailData'
        participationCriterion:
          $ref: '#/components/schemas/ParticipationCriterion'

    StudyResponse:
      type: object
      description: Full study response
      required:
        - id
        - title
        - locales
        - icon
        - details
        - participationCriterion
      properties:
        id:
          type: string
          format: uuid
        title:
          $ref: '#/components/schemas/LocalizedString'
        locales:
          type: array
          description: Supported locales for the study
          items:
            type: string
          example: ["en-US", "de-DE"]
        icon:
          type: string
          description: Icon identifier (e.g. SF Symbol name)
          example: heart
        details:
          $ref: '#/components/schemas/StudyDetailData'
        participationCriterion:
          $ref: '#/components/schemas/ParticipationCriterion'

    # ── Components — Shared ───────────────────────────────────────────────

    Component:
      type: object
      description: A component summary with type, id, and name
      required:
        - id
        - type
        - name
      properties:
        id:
          type: string
          format: uuid
        type:
          type: string
          description: Component type matching StudyDefinition.Component case names
        name:
          type: string
          description: Display name for the component

    # ── Component Schedules ─────────────────────────────────────────────

    ComponentSchedule:
      type: object
      description: A schedule defining when a component should be presented to the participant
      required:
        - scheduleDefinition
        - completionPolicy
        - notifications
      properties:
        id:
          type: string
          format: uuid
          description: Schedule ID (assigned by server on creation)
        scheduleDefinition:
          $ref: '#/components/schemas/ScheduleDefinition'
        completionPolicy:
          $ref: '#/components/schemas/AllowedCompletionPolicy'
        notifications:
          $ref: '#/components/schemas/NotificationsConfig'

    ScheduleDefinition:
      description: Defines when and how often a schedule fires
      oneOf:
        - $ref: '#/components/schemas/OnceScheduleDefinition'
        - $ref: '#/components/schemas/RepeatedScheduleDefinition'
      discriminator:
        propertyName: type
        mapping:
          once: '#/components/schemas/OnceScheduleDefinition'
          repeated: '#/components/schemas/RepeatedScheduleDefinition'

    OnceScheduleDefinition:
      type: object
      description: A schedule that fires a single time
      required:
        - type
        - pattern
      properties:
        type:
          type: string
          enum: [once]
        pattern:
          $ref: '#/components/schemas/OneTimeSchedule'
      additionalProperties: false

    RepeatedScheduleDefinition:
      type: object
      description: A schedule that fires repeatedly based on a pattern
      required:
        - type
        - pattern
      properties:
        type:
          type: string
          enum: [repeated]
        pattern:
          $ref: '#/components/schemas/RepetitionPattern'
        offset:
          $ref: '#/components/schemas/DateComponents'
      additionalProperties: false

    OneTimeSchedule:
      description: Defines when a one-time schedule fires
      oneOf:
        - $ref: '#/components/schemas/DateOneTimeSchedule'
        - $ref: '#/components/schemas/EventOneTimeSchedule'
      discriminator:
        propertyName: type
        mapping:
          date: '#/components/schemas/DateOneTimeSchedule'
          event: '#/components/schemas/EventOneTimeSchedule'

    DateOneTimeSchedule:
      type: object
      description: Fires once at a specific date
      required:
        - type
        - dateComponents
      properties:
        type:
          type: string
          enum: [date]
        dateComponents:
          $ref: '#/components/schemas/DateComponents'
      additionalProperties: false

    EventOneTimeSchedule:
      type: object
      description: Fires once in response to a study lifecycle event
      required:
        - type
        - event
      properties:
        type:
          type: string
          enum: [event]
        event:
          $ref: '#/components/schemas/StudyLifecycleEvent'
        offsetInDays:
          type: integer
          default: 0
          description: Number of days after the event
        time:
          $ref: '#/components/schemas/ScheduleTime'
      additionalProperties: false
      example:
        type: event
        event:
          type: activation
        offsetInDays: 1
        time:
          hour: 9
          minute: 0

    RepetitionPattern:
      description: Defines how a repeated schedule recurs
      oneOf:
        - $ref: '#/components/schemas/DailyRepetition'
        - $ref: '#/components/schemas/WeeklyRepetition'
        - $ref: '#/components/schemas/MonthlyRepetition'
      discriminator:
        propertyName: type
        mapping:
          daily: '#/components/schemas/DailyRepetition'
          weekly: '#/components/schemas/WeeklyRepetition'
          monthly: '#/components/schemas/MonthlyRepetition'

    DailyRepetition:
      type: object
      description: Repeats every N days at a specific time
      required:
        - type
        - hour
      properties:
        type:
          type: string
          enum: [daily]
        interval:
          type: integer
          minimum: 1
          default: 1
          description: Repeat every N days
        hour:
          type: integer
          minimum: 0
          maximum: 23
        minute:
          type: integer
          minimum: 0
          maximum: 59
          default: 0
        second:
          type: integer
          minimum: 0
          maximum: 59
          default: 0
      additionalProperties: false

    WeeklyRepetition:
      type: object
      description: Repeats every N weeks on an optional weekday at a specific time
      required:
        - type
        - hour
      properties:
        type:
          type: string
          enum: [weekly]
        interval:
          type: integer
          minimum: 1
          default: 1
          description: Repeat every N weeks
        weekday:
          type: string
          description: Day of week (e.g. "monday", "tuesday"). Omit to repeat relative to enrollment date.
          enum: [monday, tuesday, wednesday, thursday, friday, saturday, sunday]
        hour:
          type: integer
          minimum: 0
          maximum: 23
        minute:
          type: integer
          minimum: 0
          maximum: 59
          default: 0
        second:
          type: integer
          minimum: 0
          maximum: 59
          default: 0
      additionalProperties: false

    MonthlyRepetition:
      type: object
      description: Repeats every N months on an optional day at a specific time
      required:
        - type
        - hour
      properties:
        type:
          type: string
          enum: [monthly]
        interval:
          type: integer
          minimum: 1
          default: 1
          description: Repeat every N months
        day:
          type: integer
          minimum: 1
          maximum: 31
          description: Day of month. Omit to repeat relative to enrollment date.
        hour:
          type: integer
          minimum: 0
          maximum: 23
        minute:
          type: integer
          minimum: 0
          maximum: 59
          default: 0
        second:
          type: integer
          minimum: 0
          maximum: 59
          default: 0
      additionalProperties: false

    StudyLifecycleEvent:
      description: A study lifecycle event that can trigger a one-time schedule
      oneOf:
        - $ref: '#/components/schemas/EnrollmentEvent'
        - $ref: '#/components/schemas/ActivationEvent'
        - $ref: '#/components/schemas/UnenrollmentEvent'
        - $ref: '#/components/schemas/StudyEndEvent'
        - $ref: '#/components/schemas/CompletedTaskEvent'
      discriminator:
        propertyName: type
        mapping:
          enrollment: '#/components/schemas/EnrollmentEvent'
          activation: '#/components/schemas/ActivationEvent'
          unenrollment: '#/components/schemas/UnenrollmentEvent'
          studyEnd: '#/components/schemas/StudyEndEvent'
          completedTask: '#/components/schemas/CompletedTaskEvent'

    EnrollmentEvent:
      type: object
      description: Triggered on first enrollment
      required:
        - type
      properties:
        type:
          type: string
          enum: [enrollment]
      additionalProperties: false

    ActivationEvent:
      type: object
      description: Triggered on study activation
      required:
        - type
      properties:
        type:
          type: string
          enum: [activation]
      additionalProperties: false

    UnenrollmentEvent:
      type: object
      description: Triggered when participant unenrolls
      required:
        - type
      properties:
        type:
          type: string
          enum: [unenrollment]
      additionalProperties: false

    StudyEndEvent:
      type: object
      description: Triggered when the study officially ends
      required:
        - type
      properties:
        type:
          type: string
          enum: [studyEnd]
      additionalProperties: false

    CompletedTaskEvent:
      type: object
      description: Triggered when a specific component task is completed
      required:
        - type
        - componentId
      properties:
        type:
          type: string
          enum: [completedTask]
        componentId:
          type: string
          format: uuid
          description: ID of the component whose completion triggers this event
      additionalProperties: false

    ScheduleTime:
      type: object
      description: Time of day for a schedule occurrence
      required:
        - hour
      properties:
        hour:
          type: integer
          minimum: 0
          maximum: 23
        minute:
          type: integer
          minimum: 0
          maximum: 59
          default: 0
        second:
          type: integer
          minimum: 0
          maximum: 59
          default: 0
      additionalProperties: false

    AllowedCompletionPolicy:
      type: string
      description: When a scheduled event is allowed to be completed
      enum:
        - sameDay
        - afterStart
        - sameDayAfterStart
        - duringEvent
        - anytime

    NotificationsConfig:
      description: Notification configuration for a schedule
      oneOf:
        - $ref: '#/components/schemas/NotificationsDisabled'
        - $ref: '#/components/schemas/NotificationsEnabled'
      discriminator:
        propertyName: type
        mapping:
          disabled: '#/components/schemas/NotificationsDisabled'
          enabled: '#/components/schemas/NotificationsEnabled'

    NotificationsDisabled:
      type: object
      description: No notifications for schedule occurrences
      required:
        - type
      properties:
        type:
          type: string
          enum: [disabled]
      additionalProperties: false

    NotificationsEnabled:
      type: object
      description: Enable notifications for schedule occurrences
      required:
        - type
        - thread
      properties:
        type:
          type: string
          enum: [enabled]
        thread:
          $ref: '#/components/schemas/NotificationThread'
        time:
          $ref: '#/components/schemas/ScheduleTime'
      additionalProperties: false

    NotificationThread:
      description: How notifications are grouped
      oneOf:
        - $ref: '#/components/schemas/GlobalNotificationThread'
        - $ref: '#/components/schemas/TaskNotificationThread'
        - $ref: '#/components/schemas/CustomNotificationThread'
        - $ref: '#/components/schemas/NoneNotificationThread'
      discriminator:
        propertyName: type
        mapping:
          global: '#/components/schemas/GlobalNotificationThread'
          task: '#/components/schemas/TaskNotificationThread'
          custom: '#/components/schemas/CustomNotificationThread'
          none: '#/components/schemas/NoneNotificationThread'

    GlobalNotificationThread:
      type: object
      description: All notifications grouped in the global SpeziScheduler thread
      required:
        - type
      properties:
        type:
          type: string
          enum: [global]
      additionalProperties: false

    TaskNotificationThread:
      type: object
      description: Notifications grouped by task
      required:
        - type
      properties:
        type:
          type: string
          enum: [task]
      additionalProperties: false

    CustomNotificationThread:
      type: object
      description: Notifications grouped by a custom thread identifier
      required:
        - type
        - identifier
      properties:
        type:
          type: string
          enum: [custom]
        identifier:
          type: string
          description: Custom thread identifier
      additionalProperties: false

    NoneNotificationThread:
      type: object
      description: No thread identifier — grouping done automatically by iOS
      required:
        - type
      properties:
        type:
          type: string
          enum: [none]
      additionalProperties: false

    # ── Components — Informational ────────────────────────────────────────

    InformationalContent:
      type: object
      description: Content for a single locale in an informational component
      required:
        - title
        - content
      properties:
        title:
          type: string
          description: The title of the informational component
        lede:
          type: string
          description: A short introductory text or subtitle
        content:
          type: string
          description: The main content text

    InformationalComponentData:
      type: object
      description: Localized informational content keyed by locale (e.g., "en-US", "de-DE")
      additionalProperties:
        $ref: '#/components/schemas/InformationalContent'
      example:
        en-US:
          title: "Welcome"
          lede: "Introduction to the study"
          content: "Welcome to the study"
        de-DE:
          title: "Willkommen"
          lede: "Einführung in die Studie"
          content: "Willkommen zur Studie"

    InformationalComponentInput:
      type: object
      description: Request body for creating or updating an informational component
      required:
        - name
        - data
      properties:
        name:
          type: string
          description: Display name for the component
        data:
          $ref: '#/components/schemas/InformationalComponentData'

    InformationalComponentResponse:
      type: object
      description: Response containing informational component with ID and name
      required:
        - id
        - name
        - data
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
          description: Display name for the component
        data:
          $ref: '#/components/schemas/InformationalComponentData'

    # ── Components — Questionnaire ────────────────────────────────────────

    QuestionnaireContent:
      type: object
      description: Content for a single locale in a questionnaire component
      required:
        - questionnaire
      properties:
        questionnaire:
          type: string
          description: FHIR Questionnaire as JSON string

    QuestionnaireComponentData:
      type: object
      description: Localized questionnaire content keyed by locale (e.g., "en-US", "de-DE")
      additionalProperties:
        $ref: '#/components/schemas/QuestionnaireContent'
      example:
        en-US:
          questionnaire: "{\"resourceType\": \"Questionnaire\", \"title\": \"Daily Survey\"}"
        de-DE:
          questionnaire: "{\"resourceType\": \"Questionnaire\", \"title\": \"Tägliche Umfrage\"}"

    QuestionnaireComponentInput:
      type: object
      description: Request body for creating or updating a questionnaire component
      required:
        - name
        - data
      properties:
        name:
          type: string
          description: Display name for the component
        data:
          $ref: '#/components/schemas/QuestionnaireComponentData'

    QuestionnaireComponentResponse:
      type: object
      description: Response containing questionnaire component with ID and name
      required:
        - id
        - name
        - data
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
          description: Display name for the component
        data:
          $ref: '#/components/schemas/QuestionnaireComponentData'

    # ── Components — Health Data ──────────────────────────────────────────

    ExportSessionStartDate:
      description: >
        Defines how the start date of an export session is determined.
        This represents a strategy rather than a concrete date.
      oneOf:
        - $ref: '#/components/schemas/OldestSampleStartDate'
        - $ref: '#/components/schemas/RelativeStartDate'
        - $ref: '#/components/schemas/AbsoluteStartDate'
      discriminator:
        propertyName: type
        mapping:
          oldestSample: '#/components/schemas/OldestSampleStartDate'
          last: '#/components/schemas/RelativeStartDate'
          absolute: '#/components/schemas/AbsoluteStartDate'

    OldestSampleStartDate:
      type: object
      required:
        - type
      properties:
        type:
          type: string
          enum: [oldestSample]
      additionalProperties: false
      description: >
        Uses the oldest available sample as the start date.

    RelativeStartDate:
      type: object
      required:
        - type
        - components
      properties:
        type:
          type: string
          enum: [last]
        components:
          $ref: '#/components/schemas/DateComponents'
      additionalProperties: false
      description: >
        Uses a calendar-relative offset from the time the session was created.

    AbsoluteStartDate:
      type: object
      required:
        - type
        - date
      properties:
        type:
          type: string
          enum: [absolute]
        date:
          type: string
          format: date-time
      additionalProperties: false
      description: >
        Uses a fixed absolute date as the start date.

    HealthDataComponentData:
      type: object
      description: A health data component for collecting health metrics
      required:
        - sampleTypes
      properties:
        sampleTypes:
          $ref: '#/components/schemas/SampleTypesCollection'
        historicalDataCollection:
          type: object
          description: Configuration for collecting historical health data
          properties:
            enabled:
              type: boolean
              default: false
            startDate:
              $ref: '#/components/schemas/ExportSessionStartDate'

    HealthDataComponentInput:
      type: object
      description: Request body for creating or updating a health data component
      required:
        - name
        - data
      properties:
        name:
          type: string
          description: Display name for the component
        data:
          $ref: '#/components/schemas/HealthDataComponentData'

    HealthDataComponentResponse:
      type: object
      description: Response containing health data component with ID and name
      required:
        - id
        - name
        - data
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
          description: Display name for the component
        data:
          $ref: '#/components/schemas/HealthDataComponentData'
